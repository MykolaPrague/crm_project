{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block body_class %}page-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}" />
{% endblock %}

{% block content %}

<h1>
  {% blocktrans with username=user.username %}–í—ñ—Ç–∞—é, {{ username }} üëã{% endblocktrans %}
</h1>
<p class="muted">{% trans "–¶–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è." %}</p>

<div class="dash">
  <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å -->
  <aside class="dash-aside">
    <nav class="dash-nav" id="dashNav">
      <strong class="muted" style="display: block; margin-bottom: 0.25rem">
        {% trans "–†–æ–∑–¥—ñ–ª–∏" %}
      </strong>
      <a href="#overview" data-target="sec-overview" class="active">{% trans "–û–≥–ª—è–¥" %}</a>
      <a href="#calendar" data-target="sec-calendar">{% trans "–ö–∞–ª–µ–Ω–¥–∞—Ä" %}</a>
      <a href="#slots" data-target="sec-slots">{% trans "–í—ñ–ª—å–Ω—ñ —Å–ª–æ—Ç–∏" %}</a>
      <a href="#dynamics" data-target="sec-dynamics">{% trans "–î–∏–Ω–∞–º—ñ–∫–∞" %}</a>
      <a href="#activities" data-target="sec-activities">{% trans "–ú–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</a>
    </nav>
  </aside>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="dash-main">
    <div id="sec-overview">
      {% include "main/dashboard/_overview.html" %}
    </div>

    <div id="sec-calendar" class="hidden">
      {% include "main/dashboard/_calendar.html" %}
    </div>

    <div id="sec-slots" class="hidden">
      {% include "main/dashboard/_slots.html" %}
    </div>

    <div id="sec-dynamics" class="hidden">
      {% include "main/dashboard/_dynamics.html" %}
    </div>

    <div id="sec-activities" class="hidden">
      {% include "main/dashboard/_activities.html" %}
    </div>
  </section>
</div>

<!-- ======= –ú–û–î–ê–õ–ö–ê –°–ü–ò–°–ö–£ –ó–ê–ü–ò–°–Ü–í –£ –°–õ–û–¢–Ü ======= -->
<div id="slotModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <header id="slotModalTitle">{% trans "–ó–∞–ø–∏—Å–∏ —É –≤–∏–±—Ä–∞–Ω–æ–º—É —á–∞—Å—ñ" %}</header>
    <div class="body">
      <div id="slotModalList"></div>
    </div>
    <footer>
      <button class="secondary" type="button" id="slotModalCancel">{% trans "–ó–∞–∫—Ä–∏—Ç–∏" %}</button>
      <button type="button" id="slotModalCreate">‚ûï {% trans "–ù–æ–≤–∏–π –∑–∞–ø–∏—Å" %}</button>
    </footer>
  </div>
</div>

<!-- ======= –ú–û–î–ê–õ–ö–ê –ë–†–û–ù–Æ–í–ê–ù–ù–Ø ======= -->
<div id="bookingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <header>{% trans "–ù–æ–≤–∏–π –∑–∞–ø–∏—Å —É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ" %}</header>
    <div class="body">
      <form id="bookingForm">
        <fieldset>
          <legend style="margin-bottom: 0.5rem">{% trans "–†–µ–∂–∏–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è" %}</legend>
          <label>
            <input type="radio" name="mode" value="new" checked />
            {% trans "–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —É–≥–æ–¥—É –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞ + –ø–æ—Å–ª—É–≥–∏" %}
          </label>
          <label>
            <input type="radio" name="mode" value="deal" />
            {% trans "–ü—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏ –¥–æ —ñ—Å–Ω—É—é—á–æ—ó —É–≥–æ–¥–∏" %}
          </label>
        </fieldset>

        <!-- –†–µ–∂–∏–º: –Ω–æ–≤–∞ —É–≥–æ–¥–∞ (–∫–ª—ñ—î–Ω—Ç + –ø–æ—Å–ª—É–≥–∞) -->
        <div id="modeNew">
          <div class="row" style="margin-top: 0.5rem">
            <div>
              <label>{% trans "–ö–ª—ñ—î–Ω—Ç" %}</label>
              <select id="bm_client" required>
                <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞‚Ä¶" %}</option>
                {% for c in clients %}
                  <option value="{{ c.pk }}">{{ c.name }}{% if c.phone %} ‚Äî {{ c.phone }}{% endif %}</option>
                {% endfor %}
                <option value="__new__">‚ûï {% trans "–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ‚Ä¶" %}</option>
              </select>
            </div>
            <div>
              <label>{% trans "–ü–æ—Å–ª—É–≥–∞" %}</label>
              <select id="bm_service" required>
                <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É‚Ä¶" %}</option>
                {% for s in services %}
                  <option value="{{ s.pk }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- –ü–æ–ª—è –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ -->
          <div id="bm_new_client_fields" class="hidden" style="margin-top: .5rem">
            <div class="row">
              <div>
                <label for="bm_client_name">{% trans "–Ü–º‚Äô—è –∫–ª—ñ—î–Ω—Ç–∞" %}</label>
                <input id="bm_client_name" type="text" placeholder="{% trans '–ù–∞–ø—Ä. –Ü–≤–∞–Ω' %}">
              </div>
              <div>
                <label for="bm_client_phone">{% trans "–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü—ñ–π–Ω–æ)" %}</label>
                <input id="bm_client_phone" type="tel" placeholder="+420 ‚Ä¶">
              </div>
            </div>
          </div>
        </div>

        <!-- –†–µ–∂–∏–º: –¥–æ —ñ—Å–Ω—É—é—á–æ—ó —É–≥–æ–¥–∏ -->
        <div id="modeDeal" class="hidden" style="margin-top: 0.5rem">
          <label>{% trans "ID —ñ—Å–Ω—É—é—á–æ—ó —É–≥–æ–¥–∏" %}</label>
          <input id="bm_deal" type="number" min="1" placeholder="–ù–∞–ø—Ä. 123" />
          <p class="muted" style="margin: 0.25rem 0 0">
            {% trans "–î–ª—è MVP –¥–æ—Å—Ç–∞—Ç–Ω—å–æ ID; –∑–≥–æ–¥–æ–º –∑—Ä–æ–±–∏–º–æ –ø–æ—à—É–∫." %}
          </p>
        </div>

        <!-- –ú–∞–π—Å—Ç–µ—Ä / –†–µ—Å—É—Ä—Å -->
        <div class="row" style="margin-top: 1rem">
          <div>
            <label>{% trans "–ú–∞–π—Å—Ç–µ—Ä" %}</label>
            <select id="bm_master">
              <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞‚Ä¶" %}</option>
              {% for m in masters %}
                <option value="{{ m.pk }}">{{ m.full_name|default:m.user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>{% trans "–†–µ—Å—É—Ä—Å (–æ–ø—Ü—ñ–π–Ω–æ)" %}</label>
            <select id="bm_resource">
              <option value="">{% trans "‚Äî" %}</option>
              {% for r in resources %}
                <option value="{{ r.pk }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- –ß–∞—Å / –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å -->
        <div class="row" style="margin-top: 0.75rem">
          <div>
            <label>{% trans "–ü–æ—á–∞—Ç–æ–∫" %}</label>
            <input id="bm_start" type="datetime-local" required />
          </div>
          <div>
            <label>{% trans "–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)" %}</label>
            <input id="bm_duration" type="number" min="5" max="600" value="30" required />
          </div>
        </div>

        <!-- –†–µ–∂–∏–º–∏ –±–µ–∑ –º–∞–π—Å—Ç—Ä–∞ / —Ñ–æ—Ä—Å –Ω–∞–≤–∏—á–∫–∏ -->
        <div style="margin-top: 0.75rem">
          <label>
            <input type="checkbox" id="bm_no_master" /> {% trans "–ó–∞–ø–∏—Å –±–µ–∑ –º–∞–π—Å—Ç—Ä–∞" %}
          </label>
          <br />
          <label>
            <input type="checkbox" id="bm_force" /> {% trans "–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –Ω–∞–≤–∏—á–∫–∏" %}
          </label>
          <p id="bm_warn" class="muted" style="display: none; margin: 0.25rem 0 0">
            {% trans "–î–ª—è —Ü–∏—Ö —Ä–µ–∂–∏–º—ñ–≤ –±–∞–∂–∞–Ω–æ –¥–æ–¥–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä." %}
          </p>
        </div>

        <!-- –ù–æ—Ç–∞—Ç–∫–∞ -->
        <div style="margin-top: 0.75rem">
          <label>{% trans "–ù–æ—Ç–∞—Ç–∫–∞" %}</label>
          <textarea id="bm_note" rows="2" placeholder="{% trans '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è' %}"></textarea>
        </div>
      </form>
    </div>
    <footer>
      <button class="secondary" type="button" id="bm_cancel">{% trans "–°–∫–∞—Å—É–≤–∞—Ç–∏" %}</button>
      <button type="button" id="bm_save">{% trans "–ó–±–µ—Ä–µ–≥—Ç–∏" %}</button>
    </footer>
  </div>
</div>

<!-- ======= –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ ======= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>

<!-- —ñ–º–µ–Ω–æ–≤–∞–Ω—ñ URL-–∏ –¥–ª—è JS -->
<script>
  const URL_CAL_EVENTS     = "{% url 'calendar_events' %}";
  const URL_BOOKING_CREATE = "{% url 'booking_create' %}";
  const URL_BOOKING_UPDATE = "{% url 'booking_update' 0 %}".replace(/0\/?$/, ''); // –ø—Ä–µ—Ñ—ñ–∫—Å –¥–ª—è PATCH/DELETE
</script>

<script>
  /* ================== –•–µ–ª–ø–µ—Ä–∏ —Ç–∞ –∑–∞–≥–∞–ª—å–Ω—ñ ================== */
  function getCsrf() {
    const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }
  function toLocalInputValue(dateObj) {
    const pad = n => String(n).padStart(2, '0');
    return dateObj.getFullYear() + '-' + pad(dateObj.getMonth() + 1) + '-' + pad(dateObj.getDate())
      + 'T' + pad(dateObj.getHours()) + ':' + pad(dateObj.getMinutes());
  }
  function parseLocalInputValue(value) { return new Date(value); }
  function intersects(aStart, aEnd, bStart, bEnd) { return aStart < bEnd && aEnd > bStart; }

  /* ================== –ü–µ—Ä–µ–º–∏–∫–∞—á –≤–∫–ª–∞–¥–æ–∫ ================== */
  document.addEventListener('DOMContentLoaded', function () {
    const nav = document.getElementById('dashNav');
    if (!nav) return;

    const links = Array.prototype.slice.call(nav.querySelectorAll('a[data-target]'));
    const sections = Array.prototype.slice.call(document.querySelectorAll('.dash-main > div[id^="sec-"]'));

    function show(id) {
      sections.forEach(s => s.classList.toggle('hidden', s.id !== id));
      links.forEach(a => a.classList.toggle('active', a.dataset.target === id));
      if (id === 'sec-dynamics') setTimeout(initChart, 0);
      if (id === 'sec-calendar') setTimeout(initCalendar, 0);
    }
    function applyHash() {
      const hash = (location.hash || '#overview').replace('#', '');
      const id = 'sec-' + hash;
      const exists = sections.some(s => s.id === id);
      show(exists ? id : 'sec-overview');
    }
    nav.addEventListener('click', function (e) {
      const a = e.target.closest('a[data-target]');
      if (!a) return;
      e.preventDefault();
      const id = a.dataset.target;
      const hash = id.replace('sec-', '');
      if (location.hash !== '#' + hash) location.hash = hash;
      else applyHash();
    });
    window.addEventListener('hashchange', applyHash);
    applyHash();
  });

  /* ================== –ì—Ä–∞—Ñ—ñ–∫ (Chart.js) ================== */
  let chartObj = null;
  function initChart() {
    const canvas = document.getElementById('crmChart');
    if (!canvas) return;
    if (chartObj) { chartObj.resize(); return; }
    if (!window.Chart) { console.warn('Chart.js –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ'); return; }

    const labels      = {{ chart_labels_json  | default:"[]" | safe }};
    const dataClients = {{ chart_clients_json | default:"[]" | safe }};
    const dataSales   = {{ chart_sales_json   | default:"[]" | safe }};

    chartObj = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: "{% trans '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏' %}", data: dataClients, tension: .3 },
          { label: "{% trans '–°—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥' %}", data: dataSales, yAxisID: 'y1', tension: .3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y:  { beginAtZero: true, title: { display: true, text: '{% trans "–ö–ª—ñ—î–Ω—Ç–∏" %}' } },
          y1: { beginAtZero: true, position: 'right', title: { display: true, text: '{% trans "–ü—Ä–æ–¥–∞–∂—ñ" %}' }, grid: { drawOnChartArea: false } }
        }
      }
    });
  }

  /* ================== –ú–æ–¥–∞–ª–∫–∞ –°–ü–ò–°–ö–£ (slotModal) ================== */
  const $slotModal       = document.getElementById('slotModal');
  const $slotModalList   = document.getElementById('slotModalList');
  const $slotModalTitle  = document.getElementById('slotModalTitle');
  const $slotModalCancel = document.getElementById('slotModalCancel');
  const $slotModalCreate = document.getElementById('slotModalCreate');

  let slotModalState = { start: null, end: null };

  function openSlotModal({ start, end, events, disableCreate = false }){
    closeBookingModal(); // –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –ª–∏—à–µ –æ–¥–Ω–µ –≤—ñ–∫–Ω–æ

    slotModalState.start = new Date(start);
    slotModalState.end   = new Date(end);

    const fmt = d => d.toLocaleString([], {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    $slotModalTitle.textContent = `${fmt(slotModalState.start)} ‚Äì ${fmt(slotModalState.end)}`;

    $slotModalList.innerHTML = '';
    if (events.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = '{{ _("–£ —Ü—å–æ–º—É —Å–ª–æ—Ç—ñ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤") }}';
      $slotModalList.appendChild(empty);
    }else{
      const wrap = document.createElement('div');
      wrap.className = 'slot-list';
      events.forEach(ev=>{
        const row = document.createElement('div');
        row.className = 'slot-item';
        const timeStr = `${ev.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}‚Äì${(ev.end||ev.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
        row.innerHTML = `
          <div>
            <div><strong>${ev.title || '{{ _("–ë–µ–∑ –Ω–∞–∑–≤–∏") }}'}</strong></div>
            <small>${timeStr}</small>
          </div>
          <div>${ev.url ? `<a class="secondary" href="${ev.url}">{{ _("–í—ñ–¥–∫—Ä–∏—Ç–∏") }}</a>` : ''}</div>
        `;
        wrap.appendChild(row);
      });
      $slotModalList.appendChild(wrap);
    }

    if ($slotModalCreate) {
      $slotModalCreate.disabled = !!disableCreate;
      $slotModalCreate.title = disableCreate ? '{% trans "–ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å —É –º–∏–Ω—É–ª–æ–º—É" %}' : '';
    }

    $slotModal.classList.add('show');
    $slotModal.setAttribute('aria-hidden','false');
  }
  function closeSlotModal(){
    if(!$slotModal) return;
    $slotModal.classList.remove('show');
    $slotModal.setAttribute('aria-hidden','true');
  }
  $slotModalCancel?.addEventListener('click', closeSlotModal);
  $slotModalCreate?.addEventListener('click', () => {
    if(!slotModalState.start || !slotModalState.end){
      alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ–¥–æ–º–∏–π —á–∞—Å —Å–ª–æ—Ç—É');
      return;
    }
    closeSlotModal();
    openBookingModal({ start: slotModalState.start, end: slotModalState.end });
  });

  /* ================== –ú–æ–¥–∞–ª–∫–∞ –°–¢–í–û–†–ï–ù–ù–Ø (bookingModal) ================== */
  const $modal      = document.getElementById('bookingModal');
  const $form       = document.getElementById('bookingForm');
  const $bmModeNew  = document.getElementById('modeNew');
  const $bmModeDeal = document.getElementById('modeDeal');
  const $bmClient   = document.getElementById('bm_client');
  const $bmService  = document.getElementById('bm_service');
  const $bmDeal     = document.getElementById('bm_deal');
  const $bmMaster   = document.getElementById('bm_master');
  const $bmResource = document.getElementById('bm_resource');
  const $bmStart    = document.getElementById('bm_start');
  const $bmDuration = document.getElementById('bm_duration');
  const $bmNote     = document.getElementById('bm_note');
  const $bmCancel   = document.getElementById('bm_cancel');
  const $bmSave     = document.getElementById('bm_save');

  const $bmNoMaster = document.getElementById('bm_no_master');
  const $bmForce    = document.getElementById('bm_force');
  const $bmWarn     = document.getElementById('bm_warn');

  const $bmNewClientFields = document.getElementById('bm_new_client_fields');
  const $bmClientName      = document.getElementById('bm_client_name');
  const $bmClientPhone     = document.getElementById('bm_client_phone');

  if ($bmClient) {
    $bmClient.addEventListener('change', () => {
      const isNew = $bmClient.value === '__new__';
      $bmNewClientFields.classList.toggle('hidden', !isNew);
    });
  }

  let selectionDefaults = null;

  function toggleSpecialModes() {
    const noMaster = $bmNoMaster && $bmNoMaster.checked;
    const force    = $bmForce && $bmForce.checked;
    if ($bmMaster) $bmMaster.disabled = !!noMaster;
    if ($bmWarn)   $bmWarn.style.display = (noMaster || force) ? 'block' : 'none';
  }
  $bmNoMaster?.addEventListener('change', toggleSpecialModes);
  $bmForce?.addEventListener('change', toggleSpecialModes);

  function openBookingModal(selectionInfo) {
    // –∑–∞–∫—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫, —â–æ–± –Ω–µ –±—É–ª–æ –¥–≤–æ—Ö –≤—ñ–∫–æ–Ω
    closeSlotModal();

    const start = selectionInfo?.start ? new Date(selectionInfo.start) : new Date();
    const end   = selectionInfo?.end   ? new Date(selectionInfo.end)   : new Date(start.getTime() + 30 * 60000);
    
    if (isPast(end)) {
      alert('{% trans "–ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å —É –º–∏–Ω—É–ª–æ–º—É" %}');
      return;
    }
    const durationMin = Math.max(5, Math.round((end - start) / 60000));

    selectionDefaults = { start, end, durationMin };
    if ($bmStart)    $bmStart.value    = toLocalInputValue(start);
    if ($bmDuration) $bmDuration.value = durationMin;

    if ($form && $form.mode) $form.mode.value = 'new';
    $bmModeNew?.classList.remove('hidden');
    $bmModeDeal?.classList.add('hidden');

    $modal?.classList.add('show');
    $modal?.setAttribute('aria-hidden', 'false');

    toggleSpecialModes();
  }
  function closeBookingModal() {
    if (!$modal) return;
    $modal.classList.remove('show');
    $modal.setAttribute('aria-hidden', 'true');
    selectionDefaults = null;
  }
  $bmCancel?.addEventListener('click', closeBookingModal);

  $form?.addEventListener('change', function (e) {
    if (e.target.name === 'mode') {
      const mode = e.target.value;
      if (mode === 'new') {
        $bmModeNew?.classList.remove('hidden');
        $bmModeDeal?.classList.add('hidden');
      } else {
        $bmModeNew?.classList.add('hidden');
        $bmModeDeal?.classList.remove('hidden');
      }
    }
  });

  $bmSave?.addEventListener('click', async function () {
    const mode    = ($form && $form.mode) ? $form.mode.value : 'new';
    const startAt = $bmStart ? parseLocalInputValue($bmStart.value) : new Date();
    if (isPast(startAt)) {
      alert('{% trans "–ß–∞—Å –ø–æ—á–∞—Ç–∫—É –≤ –º–∏–Ω—É–ª–æ–º—É. –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π —á–∞—Å." %}');
      return;
    }
    const payload = {
      start_at: startAt.toISOString(),
      duration_min: parseInt($bmDuration ? ($bmDuration.value || '30') : '30', 10),
      resource_id: $bmResource && $bmResource.value ? parseInt($bmResource.value, 10) : null,
      note: $bmNote ? ($bmNote.value || '') : ''
    };

    const noMaster = $bmNoMaster ? $bmNoMaster.checked : false;
    const force    = $bmForce ? $bmForce.checked : false;
    payload.allow_unskilled = !!force;

    if (noMaster) {
      payload.master_id = null;
    } else {
      payload.master_id = $bmMaster ? (parseInt($bmMaster.value || '0', 10) || null) : null;
      if (!payload.master_id) {
        alert("{% trans '–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞ –∞–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å ¬´–ó–∞–ø–∏—Å –±–µ–∑ –º–∞–π—Å—Ç—Ä–∞¬ª' %}");
        return;
      }
    }

    if ((noMaster || force) && (!payload.note || !payload.note.trim())) {
      alert("{% trans '–î–æ–¥–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä –¥–ª—è —Ç–∞–∫–æ–≥–æ –∑–∞–ø–∏—Å—É' %}");
      return;
    }

    if (mode === 'new') {
      const isNewClient = ($bmClient && $bmClient.value === '__new__');
      payload.service_id = $bmService ? (parseInt($bmService.value || '0', 10) || 0) : 0;
      if (!payload.service_id) {
        alert("{% trans '–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É' %}");
        return;
      }
      if (isNewClient) {
        const name  = $bmClientName  ? ($bmClientName.value  || '').trim() : '';
        const phone = $bmClientPhone ? ($bmClientPhone.value || '').trim() : '';
        if (!name) { alert("{% trans '–í–∫–∞–∂—ñ—Ç—å —ñ–º º—è –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞' %}"); return; }
        payload.client_name  = name;
        if (phone) payload.client_phone = phone;
      } else {
        payload.client_id = $bmClient ? (parseInt($bmClient.value || '0', 10) || 0) : 0;
        if (!payload.client_id) { alert("{% trans '–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–æ–≥–æ' %}"); return; }
      }
    } else {
      payload.deal_id = $bmDeal ? (parseInt($bmDeal.value || '0', 10) || 0) : 0;
      if (!payload.deal_id) { alert("{% trans '–í–∫–∞–∂—ñ—Ç—å ID —É–≥–æ–¥–∏' %}"); return; }
    }

    try {
      const resp = await fetch(URL_BOOKING_CREATE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
        body: JSON.stringify(payload)
      });
      if (resp.ok) {
        const event = await resp.json();
        if (calendarObj && calendarObj.addEvent) calendarObj.addEvent(event);
        closeBookingModal();
      } else {
        let msg = '{% trans "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è" %}';
        try { const data = await resp.json(); if (data.message) msg = data.message; } catch (e) {}
        alert(msg);
      }
    } catch (e) {
      alert('{% trans "–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞" %}');
    }
  });
  
  function isPast(d) {
    return new Date(d).getTime() < Date.now();
  }
  function floorTo(minutes, d = new Date()) {
    const m = Math.floor(d.getMinutes() / minutes) * minutes;
    const copy = new Date(d);
    copy.setMinutes(m, 0, 0);
    return copy;
  }

  /* ================== –ö–∞–ª–µ–Ω–¥–∞—Ä (FullCalendar) ================== */
  let calendarObj = null;
  function initCalendar() {
    const el = document.getElementById('fc');
    if (!el) return;
    if (calendarObj) { calendarObj.updateSize(); calendarObj.render(); return; }

    calendarObj = new FullCalendar.Calendar(el, {
      initialView: 'timeGridWeek',
      locale: '{{ LANGUAGE_CODE|default:"uk" }}',
      firstDay: 1,
      slotMinTime: '09:00:00',
      slotMaxTime: '18:00:00',
      nowIndicator: true,
      now: new Date(),                 // —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î "–∑–∞—Ä–∞–∑"
      //validRange: function(nowDate){   // –∑–∞–±–æ—Ä–æ–Ω—è—î —Å—Ç–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Å–∏ –≤ –º–∏–Ω—É–ª–µ
      //  return { start: nowDate };
      //},
      height: 'auto',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' },
      eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      events: { url: URL_CAL_EVENTS },

      eventClassNames(arg){
        const cls = [];
        const xp = (arg && arg.event && arg.event.extendedProps) ? arg.event.extendedProps : {};
        if (!xp.master) cls.push('evt--no-master');
        if (xp.allow_unskilled) cls.push('evt--unskilled');
        if (xp.status === 'tentative') cls.push('evt--tentative');
        return cls;
      },

      editable: true,
      eventResizableFromStart: true,
      selectable: false,  // –≤–∞–∂–ª–∏–≤–æ: –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –¥—Ä—É–≥—É –º–æ–¥–∞–ª–∫—É

      dateClick(info){
        const SLOT_MIN = 30;
        const start = new Date(info.date); start.setSeconds(0,0);
        const end = new Date(start.getTime() + SLOT_MIN*60000);

        const events = calendarObj.getEvents().filter(ev => {
          const evStart = ev.start;
          const evEnd   = ev.end || new Date(ev.start.getTime() + SLOT_MIN*60000);
          return intersects(start, end, evStart, evEnd);
        });
        openSlotModal({ start, end, events, disableCreate: isPast(end) });
      },

      eventClick(info){
        info.jsEvent.preventDefault();
        const SLOT_MIN = 30;
        const start = new Date(info.event.start);
        start.setMinutes(Math.floor(start.getMinutes()/SLOT_MIN)*SLOT_MIN, 0, 0);
        const end = new Date(start.getTime() + SLOT_MIN*60000);

        const events = calendarObj.getEvents().filter(ev => {
          const evStart = ev.start;
          const evEnd   = ev.end || new Date(ev.start.getTime() + SLOT_MIN*60000);
          return intersects(start, end, evStart, evEnd);
        });
        openSlotModal({ start, end, events, disableCreate: isPast(end) });
      },

      async eventDrop(info){
        if (isPast(info.event.start)) {
          info.revert();
          alert('{% trans "–ù–µ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏ –ø–æ–¥—ñ—é –≤ –º–∏–Ω—É–ª–µ" %}');
          return;
        }
        const payload = { start_at: info.event.start.toISOString(), end_at: info.event.end.toISOString() };
        try{
          const resp = await fetch(`${URL_BOOKING_UPDATE}${info.event.id}/`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json','X-CSRFToken': getCsrf()},
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            info.revert();
            const err = await resp.json().catch(()=>({}));
            alert(err.message || '–ù–µ–º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ (–∫–æ–Ω—Ñ–ª—ñ–∫—Ç?)');
          }
        }catch(e){
          info.revert();
          alert('–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞');
        }
      },

      async eventResize(info){
        if (isPast(info.event.start)) {
          info.revert();
          alert('{% trans "–ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞–∫, —â–æ–± –ø–æ—á–∞—Ç–æ–∫ –±—É–≤ —É –º–∏–Ω—É–ª–æ–º—É" %}');
          return;
        }
        const payload = { start_at: info.event.start.toISOString(), end_at: info.event.end.toISOString() };
        try{
          const resp = await fetch(`${URL_BOOKING_UPDATE}${info.event.id}/`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json','X-CSRFToken': getCsrf()},
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            info.revert();
            const err = await resp.json().catch(()=>({}));
            alert(err.message || '–ù–µ–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å');
          }
        }catch(e){
          info.revert();
          alert('–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞');
        }
      }
    });

    requestAnimationFrame(() => calendarObj.render());
  }
</script>

{% endblock %}
