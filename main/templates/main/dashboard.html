{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block body_class %}page-dashboard{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}">{% endblock %}

{% block content %}

<h1>
  {% blocktrans with username=user.username %}–í—ñ—Ç–∞—é, {{ username }} üëã{% endblocktrans %}
</h1>
<p class="muted">{% trans "–¶–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è." %}</p>

<div class="dash">
  <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å -->
  <aside class="dash-aside">
    <nav class="dash-nav" id="dashNav">
      <strong class="muted" style="display:block;margin-bottom:.25rem">{% trans "–†–æ–∑–¥—ñ–ª–∏" %}</strong>
      <a href="#overview"   data-target="sec-overview"   class="active">{% trans "–û–≥–ª—è–¥" %}</a>
      <a href="#calendar"   data-target="sec-calendar">{% trans "–ö–∞–ª–µ–Ω–¥–∞—Ä" %}</a>
      <a href="#slots"      data-target="sec-slots">{% trans "–í—ñ–ª—å–Ω—ñ —Å–ª–æ—Ç–∏" %}</a>
      <a href="#dynamics"   data-target="sec-dynamics">{% trans "–î–∏–Ω–∞–º—ñ–∫–∞" %}</a>
      <a href="#activities" data-target="sec-activities">{% trans "–ú–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</a>
    </nav>
  </aside>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="dash-main">
    <div id="sec-overview">
      {% include "main/dashboard/_overview.html" %}
    </div>

    <div id="sec-slots" class="hidden">
      {% include "main/dashboard/_slots.html" %}
    </div>

    <div id="sec-calendar" class="hidden">
      {% include "main/dashboard/_calendar.html" %}
    </div>

    <div id="sec-dynamics" class="hidden">
      {% include "main/dashboard/_dynamics.html" %}
    </div>

    <div id="sec-activities" class="hidden">
      {% include "main/dashboard/_activities.html" %}
    </div>
  </section>
</div>

<!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>

<script>
/* ================== –ü–µ—Ä–µ–º–∏–∫–∞—á –≤–∫–ª–∞–¥–æ–∫ ================== */
document.addEventListener('DOMContentLoaded', function () {
  const nav = document.getElementById('dashNav');
  if (!nav) return;

  const links = Array.prototype.slice.call(nav.querySelectorAll('a[data-target]'));
  const sections = Array.prototype.slice.call(document.querySelectorAll('.dash-main > div[id^="sec-"]'));

  function show(id) {
    sections.forEach(function (s) { s.classList.toggle('hidden', s.id !== id); });
    links.forEach(function (a) { a.classList.toggle('active', a.dataset.target === id); });

    // –ª—ñ–Ω–∏–≤–µ —ñ–Ω—ñ—Ç –≤–∞–∂–∫–∏—Ö –≤—ñ–¥–∂–µ—Ç—ñ–≤ –ª–∏—à–µ –ø—ñ—Å–ª—è –ø–æ–∫–∞–∑—É —Å–µ–∫—Ü—ñ—ó
    if (id === 'sec-dynamics') setTimeout(initChart, 0);
    if (id === 'sec-calendar') setTimeout(initCalendar, 0);
  }

  function applyHash() {
    const hash = (location.hash || '#overview').replace('#', '');
    const id = 'sec-' + hash;
    const exists = sections.some(function (s) { return s.id === id; });
    show(exists ? id : 'sec-overview');
  }

  nav.addEventListener('click', function (e) {
    const a = e.target.closest('a[data-target]');
    if (!a) return;        // –∫–ª—ñ–∫ –Ω–µ –ø–æ –≤–∫–ª–∞–¥—Ü—ñ
    e.preventDefault();
    const id = a.dataset.target;             // 'sec-...'
    const hash = id.replace('sec-', '');
    if (location.hash !== '#' + hash) location.hash = hash;
    else applyHash();                        // —è–∫—â–æ —Ç–æ–π —Å–∞–º–∏–π —Ö–µ—à ‚Äî –ø—Ä–∏–º—É—Å–æ–≤–æ –æ–Ω–æ–≤–∏—Ç–∏
  });

  window.addEventListener('hashchange', applyHash);
  applyHash();
});

/* ================== –ì—Ä–∞—Ñ—ñ–∫ (Chart.js) ================== */
let chartObj = null;
function initChart(){
  const canvas = document.getElementById('crmChart');
  if (!canvas) return;

  // —è–∫—â–æ –≤–∂–µ —î ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—ñ–¥–ª–∞—à—Ç—É—î–º–æ —Ä–æ–∑–º—ñ—Ä
  if (chartObj) { chartObj.resize(); return; }

  if (!window.Chart) { console.warn('Chart.js –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ'); return; }

  const labels      = {{ chart_labels_json  | default:"[]" | safe }};
  const dataClients = {{ chart_clients_json | default:"[]" | safe }};
  const dataSales   = {{ chart_sales_json   | default:"[]" | safe }};

  chartObj = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: "{% trans '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏' %}", data: dataClients, tension: 0.3 },
        { label: "{% trans '–°—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥' %}", data: dataSales, yAxisID: 'y1', tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // –≤–∏—Å–æ—Ç—É –∫–æ–Ω—Ç—Ä–æ–ª—é—î .chart-box
      interaction: { mode: 'index', intersect: false },
      scales: {
        y:  { beginAtZero: true, title: { display: true, text: '{% trans "–ö–ª—ñ—î–Ω—Ç–∏" %}' } },
        y1: { beginAtZero: true, position: 'right',
              title: { display: true, text: '{% trans "–ü—Ä–æ–¥–∞–∂—ñ" %}' },
              grid:  { drawOnChartArea: false } }
      }
    }
  });
}

/* ================== –ö–∞–ª–µ–Ω–¥–∞—Ä (FullCalendar) ================== */
let calendarObj = null;
function initCalendar(){
  const el = document.getElementById('fc');
  if (!el) return;

  if (calendarObj) { calendarObj.updateSize(); calendarObj.render(); return; }
  if (!window.FullCalendar) { console.warn('FullCalendar –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ'); return; }

  calendarObj = new FullCalendar.Calendar(el, {
    initialView: 'timeGridWeek',
    locale: '{{ LANGUAGE_CODE|default:"uk" }}',
    firstDay: 1,
    slotMinTime: '09:00:00',
    slotMaxTime: '18:00:00',
    nowIndicator: true,
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'timeGridDay,timeGridWeek,dayGridMonth'
    },
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    events: {
      url: '{% url "calendar_feed" %}',
      failure: function(){ alert("{% trans '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–¥—ñ—ó' %}"); }
    },
    eventClick: function(info){
      if (info.event.url) { window.location.href = info.event.url; }
      info.jsEvent.preventDefault();
    }
  });

  // –í—ñ–¥–∫–ª–∞—Å—Ç–∏ –ø–µ—Ä—à–∏–π render –¥–æ –º–æ–º–µ–Ω—Ç—É, –∫–æ–ª–∏ —Å–µ–∫—Ü—ñ—é –≤–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
  requestAnimationFrame(function(){ calendarObj.render(); });
}
</script>

{% endblock %}
