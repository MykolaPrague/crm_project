{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block body_class %}page-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}">
{% endblock %}

{% block content %}

<h1>
  {% blocktrans with username=user.username %}–í—ñ—Ç–∞—é, {{ username }} üëã{% endblocktrans %}
</h1>
<p class="muted">{% trans "–¶–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è." %}</p>

<div class="dash">
  <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å -->
  <aside class="dash-aside">
    <nav class="dash-nav" id="dashNav">
      <strong class="muted" style="display:block;margin-bottom:.25rem;">{% trans "–†–æ–∑–¥—ñ–ª–∏" %}</strong>
      <a href="#overview"  data-target="sec-overview"  class="active">{% trans "–û–≥–ª—è–¥" %}</a>
      <a href="#calendar"  data-target="sec-calendar">{% trans "–ö–∞–ª–µ–Ω–¥–∞—Ä" %}</a>
      <a href="#slots"     data-target="sec-slots">{% trans "–í—ñ–ª—å–Ω—ñ —Å–ª–æ—Ç–∏" %}</a>
      <a href="#dynamics"  data-target="sec-dynamics">{% trans "–î–∏–Ω–∞–º—ñ–∫–∞" %}</a>
      <a href="#activities" data-target="sec-activities">{% trans "–ú–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</a>
    </nav>
  </aside>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="dash-main">
    <div id="sec-overview">
      {% include "main/dashboard/_overview.html" %}
    </div>

    <div id="sec-calendar" class="hidden">
      {% include "main/dashboard/_calendar.html" %}
    </div>

    <div id="sec-slots" class="hidden">
      {% include "main/dashboard/_slots.html" %}
    </div>

    <div id="sec-dynamics" class="hidden">
      {% include "main/dashboard/_dynamics.html" %}
    </div>

    <div id="sec-activities" class="hidden">
      {% include "main/dashboard/_activities.html" %}
    </div>
  </section>
</div>

<div id="bookingModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <header>{% trans "–ù–æ–≤–∏–π –∑–∞–ø–∏—Å —É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ" %}</header>
    <div class="body">
      <form id="bookingForm">
        <fieldset>
          <legend style="margin-bottom:.5rem">{% trans "–†–µ–∂–∏–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è" %}</legend>
          <label>
            <input type="radio" name="mode" value="new" checked>
            {% trans "–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —É–≥–æ–¥—É –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞ + –ø–æ—Å–ª—É–≥–∏" %}
          </label>
          <label>
            <input type="radio" name="mode" value="deal">
            {% trans "–ü—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏ –¥–æ —ñ—Å–Ω—É—é—á–æ—ó —É–≥–æ–¥–∏" %}
          </label>
        </fieldset>

        <div id="modeNew">
          <div class="row" style="margin-top:.5rem;">
            <div>
              <label>{% trans "–ö–ª—ñ—î–Ω—Ç" %}</label>
              <select id="bm_client" required>
                <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞‚Ä¶" %}</option>
                {% for c in clients %}
                  <option value="{{ c.pk }}">{{ c.name }}{% if c.phone %} ‚Äî {{ c.phone }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>{% trans "–ü–æ—Å–ª—É–≥–∞" %}</label>
              <select id="bm_service" required>
                <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É‚Ä¶" %}</option>
                {% for s in services %}
                  <option value="{{ s.pk }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div id="modeDeal" class="hidden" style="margin-top:.5rem;">
          <label>{% trans "ID —ñ—Å–Ω—É—é—á–æ—ó —É–≥–æ–¥–∏" %}</label>
          <input id="bm_deal" type="number" min="1" placeholder="–ù–∞–ø—Ä. 123">
          <p class="muted" style="margin:.25rem 0 0">{% trans "–î–ª—è MVP –¥–æ—Å—Ç–∞—Ç–Ω—å–æ ID; –∑–≥–æ–¥–æ–º –∑—Ä–æ–±–∏–º–æ –ø–æ—à—É–∫." %}</p>
        </div>

        <div class="row" style="margin-top:1rem;">
          <div>
            <label>{% trans "–ú–∞–π—Å—Ç–µ—Ä" %}</label>
            <select id="bm_master" required>
              <option value="">{% trans "–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞‚Ä¶" %}</option>
              {% for m in masters %}
                <option value="{{ m.pk }}">{{ m.full_name|default:m.user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>{% trans "–†–µ—Å—É—Ä—Å (–æ–ø—Ü—ñ–π–Ω–æ)" %}</label>
            <select id="bm_resource">
              <option value="">{% trans "‚Äî" %}</option>
              {% for r in resources %}
                <option value="{{ r.pk }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:.75rem;">
          <div>
            <label>{% trans "–ü–æ—á–∞—Ç–æ–∫" %}</label>
            <input id="bm_start" type="datetime-local" required>
          </div>
          <div>
            <label>{% trans "–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)" %}</label>
            <input id="bm_duration" type="number" min="5" max="600" value="30" required>
          </div>
        </div>

        <div style="margin-top:.75rem;">
          <label>{% trans "–ù–æ—Ç–∞—Ç–∫–∞" %}</label>
          <textarea id="bm_note" rows="2" placeholder="{% trans '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è' %}"></textarea>
        </div>
      </form>
    </div>
    <footer>
      <button class="secondary" type="button" id="bm_cancel">{% trans "–°–∫–∞—Å—É–≤–∞—Ç–∏" %}</button>
      <button type="button" id="bm_save">{% trans "–ó–±–µ—Ä–µ–≥—Ç–∏" %}</button>
    </footer>
  </div>
</div>

<!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>

<script>
/* ================== –ü–µ—Ä–µ–º–∏–∫–∞—á –≤–∫–ª–∞–¥–æ–∫ ================== */
document.addEventListener('DOMContentLoaded', function () {
  const nav = document.getElementById('dashNav');
  if (!nav) return;

  const links    = Array.prototype.slice.call(nav.querySelectorAll('a[data-target]'));
  const sections = Array.prototype.slice.call(document.querySelectorAll('.dash-main > div[id^="sec-"]'));

  function show(id) {
    sections.forEach(s => s.classList.toggle('hidden', s.id !== id));
    links.forEach(a => a.classList.toggle('active', a.dataset.target === id));
    if (id === 'sec-dynamics') setTimeout(initChart, 0);
    if (id === 'sec-calendar') setTimeout(initCalendar, 0);
  }

  function applyHash() {
    const hash = (location.hash || '#overview').replace('#', '');
    const id = 'sec-' + hash;
    const exists = sections.some(s => s.id === id);
    show(exists ? id : 'sec-overview');
  }

  nav.addEventListener('click', function (e) {
    const a = e.target.closest('a[data-target]');
    if (!a) return;
    e.preventDefault();
    const id = a.dataset.target;
    const hash = id.replace('sec-', '');
    if (location.hash !== '#' + hash) location.hash = hash;
    else applyHash();
  });

  window.addEventListener('hashchange', applyHash);
  applyHash();
});

/* ================== –ì—Ä–∞—Ñ—ñ–∫ (Chart.js) ================== */
let chartObj = null;
function initChart(){
  const canvas = document.getElementById('crmChart');
  if (!canvas) return;
  if (chartObj) { chartObj.resize(); return; }

  if (!window.Chart) { console.warn('Chart.js –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ'); return; }

  const labels      = {{ chart_labels_json  | default:"[]" | safe }};
  const dataClients = {{ chart_clients_json | default:"[]" | safe }};
  const dataSales   = {{ chart_sales_json   | default:"[]" | safe }};

  chartObj = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: "{% trans '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏' %}", data: dataClients, tension: .3 },
        { label: "{% trans '–°—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥' %}", data: dataSales, yAxisID: 'y1', tension: .3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y:  { beginAtZero: true, title: { display: true, text: '{% trans "–ö–ª—ñ—î–Ω—Ç–∏" %}' } },
        y1: { beginAtZero: true, position: 'right', title: { display: true, text: '{% trans "–ü—Ä–æ–¥–∞–∂—ñ" %}' }, grid: { drawOnChartArea: false } }
      }
    }
  });
}

/* ================== –ö–∞–ª–µ–Ω–¥–∞—Ä (FullCalendar) ================== */
let calendarObj = null;

function initCalendar(){
  const el = document.getElementById('fc');
  if (!el) return;

  if (calendarObj) { calendarObj.updateSize(); calendarObj.render(); return; }

  calendarObj = new FullCalendar.Calendar(el, {
    initialView: 'timeGridWeek',
    locale: '{{ LANGUAGE_CODE|default:"uk" }}',
    firstDay: 1,
    slotMinTime: '09:00:00',
    slotMaxTime: '18:00:00',
    nowIndicator: true,
    height: 'auto',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' },
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    events: { url: '/api/calendar/events/' },

    /* —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    selectable: true,
    selectMirror: true,
    editable: true,
    eventResizableFromStart: true,

    /* –ø—Ä–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É */
    select: function(info){ openBookingModal(info); },

    eventDrop: async function(info){
      const payload = { start_at: info.event.start.toISOString(), end_at: info.event.end.toISOString() };
      try{
        const resp = await fetch(`/api/calendar/bookings/${info.event.id}/`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json', 'X-CSRFToken': getCsrf()},
          body: JSON.stringify(payload)
        });
        if(!resp.ok){
          info.revert();
          const err = await resp.json().catch(()=>({}));
          alert(err.message || '–ù–µ–º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ (–∫–æ–Ω—Ñ–ª—ñ–∫—Ç?)');
        }
      }catch(e){
        info.revert();
        alert('–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞');
      }
    },

    eventResize: async function(info){
      const payload = { start_at: info.event.start.toISOString(), end_at: info.event.end.toISOString() };
      try{
        const resp = await fetch(`/api/calendar/bookings/${info.event.id}/`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json', 'X-CSRFToken': getCsrf()},
          body: JSON.stringify(payload)
        });
        if(!resp.ok){
          info.revert();
          const err = await resp.json().catch(()=>({}));
          alert(err.message || '–ù–µ–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å');
        }
      }catch(e){
        info.revert();
        alert('–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞');
      }
    },

    eventClick: function(info){
      if (info.event.url) { window.location.href = info.event.url; }
      info.jsEvent.preventDefault();
    }
  });

  requestAnimationFrame(() => calendarObj.render());
}

/* ================== –ú–æ–¥–∞–ª–∫–∞: –ª–æ–≥—ñ–∫–∞ ================== */
function getCsrf(){
  const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : '';
}
function toLocalInputValue(dateObj){
  const pad = n => String(n).padStart(2,'0');
  return dateObj.getFullYear() + '-' + pad(dateObj.getMonth()+1) + '-' + pad(dateObj.getDate())
       + 'T' + pad(dateObj.getHours()) + ':' + pad(dateObj.getMinutes());
}
function parseLocalInputValue(value){ return new Date(value); }

const $modal     = document.getElementById('bookingModal');
const $form      = document.getElementById('bookingForm');
const $bmModeNew = document.getElementById('modeNew');
const $bmModeDeal= document.getElementById('modeDeal');
const $bmClient  = document.getElementById('bm_client');
const $bmService = document.getElementById('bm_service');
const $bmDeal    = document.getElementById('bm_deal');
const $bmMaster  = document.getElementById('bm_master');
const $bmResource= document.getElementById('bm_resource');
const $bmStart   = document.getElementById('bm_start');
const $bmDuration= document.getElementById('bm_duration');
const $bmNote    = document.getElementById('bm_note');
const $bmCancel  = document.getElementById('bm_cancel');
const $bmSave    = document.getElementById('bm_save');

let selectionDefaults = null;

function openBookingModal(selectionInfo){
  const start = selectionInfo?.start ? new Date(selectionInfo.start) : new Date();
  const end   = selectionInfo?.end   ? new Date(selectionInfo.end)   : new Date(start.getTime() + 30*60000);
  const durationMin = Math.max(5, Math.round((end - start) / 60000));

  selectionDefaults = { start, end, durationMin };
  $bmStart.value    = toLocalInputValue(start);
  $bmDuration.value = durationMin;

  $form.mode.value = 'new';
  $bmModeNew.classList.remove('hidden');
  $bmModeDeal.classList.add('hidden');

  $modal.classList.add('show');
  $modal.setAttribute('aria-hidden', 'false');
}

function closeBookingModal(){
  $modal.classList.remove('show');
  $modal.setAttribute('aria-hidden', 'true');
  selectionDefaults = null;
}

$form.addEventListener('change', function(e){
  if (e.target.name === 'mode'){
    const mode = e.target.value;
    if (mode === 'new'){
      $bmModeNew.classList.remove('hidden');
      $bmModeDeal.classList.add('hidden');
    } else {
      $bmModeNew.classList.add('hidden');
      $bmModeDeal.classList.remove('hidden');
    }
  }
});
$bmCancel.addEventListener('click', closeBookingModal);

$bmSave.addEventListener('click', async function(){
  const mode = $form.mode.value;
  const startAt = parseLocalInputValue($bmStart.value);
  const payload = {
    start_at: startAt.toISOString(),
    duration_min: parseInt($bmDuration.value || '30', 10),
    master_id: parseInt($bmMaster.value || '0', 10),
    resource_id: $bmResource.value ? parseInt($bmResource.value, 10) : null,
    note: $bmNote.value || ''
  };

  if (!payload.master_id || !payload.start_at) {
    alert("{% trans '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è' %}");
    return;
  }

  if (mode === 'new'){
    payload.client_id = parseInt($bmClient.value || '0', 10);
    payload.service_id = parseInt($bmService.value || '0', 10);
    if (!payload.client_id || !payload.service_id){
      alert("{% trans '–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ –ø–æ—Å–ª—É–≥—É' %}");
      return;
    }
  } else {
    payload.deal_id = parseInt($bmDeal.value || '0', 10);
    if (!payload.deal_id){
      alert("{% trans '–í–∫–∞–∂—ñ—Ç—å ID —É–≥–æ–¥–∏' %}");
      return;
    }
  }

  try{
    const resp = await fetch('/api/calendar/bookings/', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrf() },
      body: JSON.stringify(payload)
    });
    if (resp.ok){
      const event = await resp.json();
      calendarObj.addEvent(event);
      closeBookingModal();
    } else {
      let msg = '{% trans "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è" %}';
      try { const data = await resp.json(); if (data.message) msg = data.message; } catch(e){}
      alert(msg);
    }
  } catch (e){
    alert('{% trans "–ú–µ—Ä–µ–∂–Ω–∞ –ø–æ–º–∏–ª–∫–∞" %}');
  }
});
</script>

{% endblock %}
