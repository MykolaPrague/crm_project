{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h1>{{ deal.title }}</h1>
<p>
  <strong>{% trans "–ö–ª—ñ—î–Ω—Ç:" %}</strong> <a href="{% url 'client_detail' deal.client.pk %}">{{ deal.client.name }}</a><br>
  <strong>{% trans "–°—É–º–∞:" %}</strong> {{ deal.amount }}<br>
  <strong>{% trans "–°—Ç–∞—Ç—É—Å:" %}</strong>
  {% if deal.status == "closed" %}{% trans "‚úÖ –ó–∞–∫—Ä–∏—Ç–æ" %}
  {% elif deal.status == "in_progress" %}{% trans "üîÑ –í —Ä–æ–±–æ—Ç—ñ" %}
  {% else %}{% trans "üÜï –ù–æ–≤–∏–π" %}
  {% endif %}
</p>

{% if deal.notes %}
  <article>
    <header><strong>{% trans "–ù–æ—Ç–∞—Ç–∫–∏" %}</strong></header>
    <p>{{ deal.notes|linebreaksbr }}</p>
  </article>
{% endif %}

<hr>
<h3>{% trans "–í–∫–ª–∞–¥–µ–Ω–Ω—è" %}</h3>

{% if attachments %}
<table>
  <thead>
    <tr>
      <th>{% trans "–§–∞–π–ª" %}</th>
      <th>{% trans "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ" %}</th>
      <th>{% trans "–ö–∏–º" %}</th>
      {% if user.is_staff or user.is_superuser %}<th></th>{% endif %}
    </tr>
  </thead>
  <tbody>
    {% for a in attachments %}
      <tr>
        <td><a href="{{ a.file.url }}" target="_blank" rel="noopener">{{ a.filename }}</a></td>
        <td>{{ a.uploaded_at|date:"Y-m-d H:i" }}</td>
        <td>{{ a.uploaded_by|default:"‚Äî" }}</td>
        {% if user.is_staff or user.is_superuser %}
          <td>
            <form method="post" action="{% url 'deal_attachment_delete' a.pk %}">
              {% csrf_token %}
              <button type="submit" class="secondary">{% trans "–í–∏–¥–∞–ª–∏—Ç–∏" %}</button>
            </form>
          </td>
        {% endif %}
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <p>{% trans "–§–∞–π–ª—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î." %}</p>
{% endif %}

{% if user.is_staff or user.is_superuser %}
  <form method="post" action="{% url 'deal_attachment_upload' deal.pk %}" enctype="multipart/form-data" style="margin-top:1rem">
    {% csrf_token %}
    <label>{% trans "–î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª" %}</label>
    {{ form.file }}
    <button type="submit">{% trans "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" %}</button>
  </form>
{% endif %}

<hr>
<h3>{% trans "–ü–æ—Å–ª—É–≥–∏ –≤ —É–≥–æ–¥—ñ" %}</h3>

{% if lines %}
<table>
  <thead>
    <tr>
      <th>{% trans "–ü–æ—Å–ª—É–≥–∞" %}</th>
      <th>{% trans "–ö-—Å—Ç—å" %}</th>
      <th>{% trans "–¶—ñ–Ω–∞ –∑–∞ –æ–¥." %}</th>
      <th>{% trans "–°—É–º–∞" %}</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for line in lines %}
    <tr>
      <td>{{ line.service.name }}</td>
      <td>{{ line.quantity }}</td>
      <td>{{ line.unit_price }}</td>
      <td>{{ line.subtotal }}</td>
      <td style="white-space:nowrap">
        <form method="post" action="{% url 'deal_line_delete' line.pk %}">
          {% csrf_token %}
          <button class="secondary" type="submit">{% trans "–í–∏–¥–∞–ª–∏—Ç–∏" %}</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>{% trans "–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –ø–æ—Å–ª—É–≥." %}</p>
{% endif %}

<form method="post" action="{% url 'deal_detail' deal.pk %}" style="margin-top:1rem;">
  {% csrf_token %}
  <input type="hidden" name="form_type" value="line">
  <fieldset>
    <legend>{% trans "+ –î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É" %}</legend>
    {{ line_form.as_p }}
    <button type="submit">{% trans "–î–æ–¥–∞—Ç–∏" %}</button>
  </fieldset>
</form>

<hr>
<h3>{% trans "–ó–∞–ø–∏—Å —É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ" %}</h3>
{% if deal.booking %}
  <p>
    <strong>{% trans "–ü–æ—á–∞—Ç–æ–∫:" %}</strong> {{ deal.booking.start_at|date:"Y-m-d H:i" }}<br>
    <strong>{% trans "–ö—ñ–Ω–µ—Ü—å:" %}</strong> {{ deal.booking.end_at|date:"Y-m-d H:i" }}<br>
    <strong>{% trans "–ú–∞–π—Å—Ç–µ—Ä:" %}</strong> {{ deal.booking.master }}<br>
    {% if deal.booking.resource %}
      <strong>{% trans "–†–µ—Å—É—Ä—Å:" %}</strong> {{ deal.booking.resource }}<br>
    {% endif %}
    {% if deal.booking.note %}<em>{{ deal.booking.note }}</em>{% endif %}
  </p>
{% else %}
  <p>{% trans "–ü–æ–∫–∏ –Ω–µ–º–∞—î –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è." %}</p>
{% endif %}

<form method="post" action="{% url 'deal_detail' deal.pk %}">
  {% csrf_token %}
  <input type="hidden" name="form_type" value="booking">
  <fieldset>
    <legend>{% trans "–°—Ç–≤–æ—Ä–∏—Ç–∏/–æ–Ω–æ–≤–∏—Ç–∏ –∑–∞–ø–∏—Å" %}</legend>
    {{ booking_form.as_p }}
    <button type="submit">{% trans "–ó–±–µ—Ä–µ–≥—Ç–∏" %}</button>
  </fieldset>
</form>


<div style="margin-top:1rem">
  <a href="{% url 'client_detail' deal.client.pk %}" role="button" class="secondary">{% trans "‚Üê –î–æ –∫–ª—ñ—î–Ω—Ç–∞" %}</a>
</div>
{% endblock %}
