{% extends "base.html" %}
{% load i18n %}
{% block content %}
<h1>{{ deal.title }}</h1>
<p>
  <strong>{% trans "–ö–ª—ñ—î–Ω—Ç:" %}</strong> <a href="{% url 'client_detail' deal.client.pk %}">{{ deal.client.name }}</a><br>
  <strong>{% trans "–°—É–º–∞:" %}</strong> {{ deal.amount }}<br>
  <strong>{% trans "–°—Ç–∞—Ç—É—Å:" %}</strong>
  {% if deal.status == "closed" %}{% trans "‚úÖ –ó–∞–∫—Ä–∏—Ç–æ" %}
  {% elif deal.status == "in_progress" %}{% trans "üîÑ –í —Ä–æ–±–æ—Ç—ñ" %}
  {% else %}{% trans "üÜï –ù–æ–≤–∏–π" %}
  {% endif %}
</p>

{% if deal.notes %}
  <article>
    <header><strong>{% trans "–ù–æ—Ç–∞—Ç–∫–∏" %}</strong></header>
    <p>{{ deal.notes|linebreaksbr }}</p>
  </article>
{% endif %}

<hr>
<h3>{% trans "–í–∫–ª–∞–¥–µ–Ω–Ω—è" %}</h3>

{% if attachments %}
<table>
  <thead>
    <tr>
      <th>{% trans "–§–∞–π–ª" %}</th>
      <th>{% trans "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ" %}</th>
      <th>{% trans "–ö–∏–º" %}</th>
      {% if user.is_staff or user.is_superuser %}<th></th>{% endif %}
    </tr>
  </thead>
  <tbody>
    {% for a in attachments %}
      <tr>
        <td><a href="{{ a.file.url }}" target="_blank" rel="noopener">{{ a.filename }}</a></td>
        <td>{{ a.uploaded_at|date:"Y-m-d H:i" }}</td>
        <td>{{ a.uploaded_by|default:"‚Äî" }}</td>
        {% if user.is_staff or user.is_superuser %}
          <td>
            <form method="post" action="{% url 'deal_attachment_delete' a.pk %}">
              {% csrf_token %}
              <button type="submit" class="secondary">{% trans "–í–∏–¥–∞–ª–∏—Ç–∏" %}</button>
            </form>
          </td>
        {% endif %}
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <p>{% trans "–§–∞–π–ª—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î." %}</p>
{% endif %}

{% if user.is_staff or user.is_superuser %}
  <form method="post" action="{% url 'deal_attachment_upload' deal.pk %}" enctype="multipart/form-data" style="margin-top:1rem">
    {% csrf_token %}
    <label>{% trans "–î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª" %}</label>
    {{ form.file }}
    <button type="submit">{% trans "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" %}</button>
  </form>
{% endif %}

<div style="margin-top:1rem">
  <a href="{% url 'client_detail' deal.client.pk %}" role="button" class="secondary">{% trans "‚Üê –î–æ –∫–ª—ñ—î–Ω—Ç–∞" %}</a>
</div>
{% endblock %}
