{% load i18n %}
{% extends "base.html" %}
{% block content %}

<h1>{% blocktrans with username=user.username %}–í—ñ—Ç–∞—é, {{ username }} üëã{% endblocktrans %}</h1>
<p>{% trans "–¶–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è." %}</p>

<div class="grid">
  {% if user.is_superuser %}
  <article>
    <header><strong>{% trans "–ê–¥–º—ñ–Ω-—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏" %}</strong></header>
    <p>{% trans "–ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –æ—Ü—ñ–Ω–∫–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤." %}</p>
    <footer>
      <a href="{% url 'admin_panel' %}" role="button">{% trans "–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å" %}</a>
    </footer>

    <h3>{% trans "–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∞–¥–º—ñ–Ω)" %}</h3>
    <p>{% trans "–ó–∞ 7 –¥–Ω—ñ–≤" %}: <strong>{{ all_week_count|default:"0" }}</strong></p>
    <p>{% trans "–í—Å—å–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π" %}: <strong>{{ all_total|default:"0" }}</strong></p>
  </article>
  {% elif user.is_staff %}
  <article>
    <header><strong>{% trans "–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞" %}</strong></header>
    <p>{% trans "–ö–æ—Ä–æ—Ç–∫—ñ –º–µ—Ç—Ä–∏–∫–∏ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ —à–≤–∏–¥–∫—ñ –¥—ñ—ó." %}</p>
    <footer><a href="#" role="button">{% trans "–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ä–æ–∑–¥—ñ–ª" %}</a></footer>
  </article>
  {% endif %}
</div>

<section class="grid" style="margin-block:1rem;">
  <article>
    <header><strong>{% trans "–ö–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞ 30 –¥–Ω—ñ–≤" %}</strong></header>
    <h3 style="margin:0">{{ clients_last_month }}</h3>
  </article>
  <article>
    <header><strong>{% trans "–£–≥–æ–¥ (–≤—Å—å–æ–≥–æ)" %}</strong></header>
    <h3 style="margin:0">{{ deals_total }}</h3>
  </article>
  <article>
    <header><strong>{% trans "–ü—Ä–æ–¥–∞–∂—ñ (–∑–∞–∫—Ä–∏—Ç—ñ), ‚Ç¥" %}</strong></header>
    <h3 style="margin:0">{{ sales_sum }}</h3>
  </article>
</section>

<article>
  <header><strong>{% trans "–î–∏–Ω–∞–º—ñ–∫–∞: –Ω–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏ —Ç–∞ —Å—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥" %}</strong></header>
  <canvas id="crmChart" height="110"></canvas>
</article>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ chart_labels_json|safe }};
  const dataClients = {{ chart_clients_json|safe }};
  const dataSales = {{ chart_sales_json|safe }};

  const ctx = document.getElementById('crmChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: "{% trans '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏' %}",
          data: dataClients,
          tension: 0.3,
        },
        {
          label: "{% trans '–°—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥' %}",
          data: dataSales,
          yAxisID: 'y1',
          tension: 0.3,
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: '{% trans "–ö–ª—ñ—î–Ω—Ç–∏" %}' } },
        y1: {
          beginAtZero: true,
          position: 'right',
          title: { display: true, text: '{% trans "–ü—Ä–æ–¥–∞–∂—ñ" %}' },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
</script>

<hr />
<div class="grid">
  <article>
    <header><strong>{% trans "–ú–æ—ó –∑–∞–¥–∞—á—ñ / —É–≥–æ–¥–∏" %}</strong></header>
    <p>{% trans "–í–∞—à—ñ –æ—Å—Ç–∞–Ω–Ω—ñ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ —à–≤–∏–¥–∫—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è." %}</p>
    <hr />
    <p>
      <a href="{% url 'activity_create' %}" role="button">{% trans "+ –î–æ–¥–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å" %}</a>
    </p>
  </article>
</div>

<hr />
<form method="get" class="grid" style="align-items:end; gap: 1rem;">
  <div>
    <label for="kind">{% trans "–¢–∏–ø" %}</label>
    <select name="kind" id="kind">
      <option value="" {% if not filter_kind %}selected{% endif %}>{% trans "–ë—É–¥—å-—è–∫–∏–π" %}</option>
      <option value="call"  {% if filter_kind == "call" %}selected{% endif %}>{% trans "–î–∑–≤—ñ–Ω–æ–∫" %}</option>
      <option value="meet"  {% if filter_kind == "meet" %}selected{% endif %}>{% trans "–ó—É—Å—Ç—Ä—ñ—á" %}</option>
      <option value="deal"  {% if filter_kind == "deal" %}selected{% endif %}>{% trans "–£–≥–æ–¥–∞" %}</option>
      <option value="task"  {% if filter_kind == "task" %}selected{% endif %}>{% trans "–ó–∞–≤–¥–∞–Ω–Ω—è" %}</option>
      <option value="other" {% if filter_kind == "other" %}selected{% endif %}>{% trans "–Ü–Ω—à–µ" %}</option>
    </select>
  </div>

  <div>
    <label for="from">{% trans "–í—ñ–¥ –¥–∞—Ç–∏" %}</label>
    <input type="date" id="from" name="from" value="{{ filter_from }}">
  </div>

  <div>
    <label for="to">{% trans "–î–æ –¥–∞—Ç–∏" %}</label>
    <input type="date" id="to" name="to" value="{{ filter_to }}">
  </div>

  <div>
    <label for="sort">{% trans "–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è" %}</label>
    <select name="sort" id="sort">
      <option value="-created_at" {% if sort == "-created_at" %}selected{% endif %}>{% trans "–ù–æ–≤—ñ —Å–ø–æ—á–∞—Ç–∫—É" %}</option>
      <option value="created_at"  {% if sort == "created_at" %}selected{% endif %}>{% trans "–°—Ç–∞—Ä—ñ —Å–ø–æ—á–∞—Ç–∫—É" %}</option>
      <option value="-duration_min" {% if sort == "-duration_min" %}selected{% endif %}>{% trans "–î–æ–≤—à—ñ —Å–ø–æ—á–∞—Ç–∫—É" %}</option>
      <option value="duration_min"  {% if sort == "duration_min" %}selected{% endif %}>{% trans "–ö–æ—Ä–æ—Ç—à—ñ —Å–ø–æ—á–∞—Ç–∫—É" %}</option>
    </select>
  </div>

  <div class="grid">
    <button type="submit">{% trans "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" %}</button>
    <button type="button" onclick="window.location.href='{% url 'dashboard' %}'" class="secondary">
      {% trans "–°–∫–∏–Ω—É—Ç–∏" %}
    </button>
  </div>
</form>

<h3>{% trans "–ú–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ" %}</h3>
<p>{% trans "–°—å–æ–≥–æ–¥–Ω—ñ" %}: <strong>{{ my_today_count }}</strong></p>

<table>
  <thead>
    <tr>
      <th>{% trans "–¢–∏–ø" %}</th>
      <th>{% trans "–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)" %}</th>
      <th>{% trans "–ù–æ—Ç–∞—Ç–∫–∏" %}</th>
      <th>{% trans "–î–∞—Ç–∞" %}</th>
      <th>{% trans "–î—ñ—ó" %}</th>
    </tr>
  </thead>
  <tbody>
    {% for a in my_latest_activities %}
    <tr>
      <td>{{ a.get_kind_display }}</td>
      <td>{{ a.duration_min }}</td>
      <td>{{ a.notes|default:"‚Äî" }}</td>
      <td>{{ a.created_at|date:"Y-m-d H:i" }}</td>
      <td style="white-space:nowrap">
        <a href="{% url 'activity_edit' a.pk %}">{% trans "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" %}</a>
        &nbsp;|&nbsp;
        <a href="{% url 'activity_delete' a.pk %}">{% trans "–í–∏–¥–∞–ª–∏—Ç–∏" %}</a>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="5">{% trans "–ü–æ–∫–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π" %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
