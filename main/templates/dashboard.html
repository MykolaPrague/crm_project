{% extends "base.html" %} {% block content %}
<h1>–í—ñ—Ç–∞—é, {{ user.username }} üëã</h1>
<p>–¶–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è.</p>

<div class="grid">
  {% if user.is_superuser %}
  <article>
    <header><strong>–ê–¥–º—ñ–Ω-—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</strong></header>
    <p>–ó–≤–µ–¥–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –æ—Ü—ñ–Ω–∫–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤.</p>
    <footer>
      <a href="{% url 'admin_panel' %}" role="button">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</a>
    </footer>
  {% if user.is_superuser %}
    <h3>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∞–¥–º—ñ–Ω)</h3>
    <p>–ó–∞ 7 –¥–Ω—ñ–≤: <strong>{{ all_week_count|default:"0" }}</strong></p>
    <p>–í—Å—å–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π: <strong>{{ all_total|default:"0" }}</strong></p>
  </article>
  {% endif %} {% if user.is_staff and not user.is_superuser %}
  <article>
    <header><strong>–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</strong></header>
    <p>–ö–æ—Ä–æ—Ç–∫—ñ –º–µ—Ç—Ä–∏–∫–∏ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ —à–≤–∏–¥–∫—ñ –¥—ñ—ó.</p>
    <footer><a href="#" role="button">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ä–æ–∑–¥—ñ–ª</a></footer>
  </article>
  {% endif %}

</div>


<section class="grid" style="margin-block:1rem;">
  <article>
    <header><strong>–ö–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞ 30 –¥–Ω—ñ–≤</strong></header>
    <h3 style="margin:0">{{ clients_last_month }}</h3>
  </article>
  <article>
    <header><strong>–£–≥–æ–¥ (–≤—Å—å–æ–≥–æ)</strong></header>
    <h3 style="margin:0">{{ deals_total }}</h3>
  </article>
  <article>
    <header><strong>–ü—Ä–æ–¥–∞–∂—ñ (–∑–∞–∫—Ä–∏—Ç—ñ), ‚Ç¥</strong></header>
    <h3 style="margin:0">{{ sales_sum }}</h3>
  </article>
</section>

<article>
  <header><strong>–î–∏–Ω–∞–º—ñ–∫–∞: –Ω–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏ —Ç–∞ —Å—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥</strong></header>
  <canvas id="crmChart" height="110"></canvas>
</article>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ chart_labels_json|safe }};
  const dataClients = {{ chart_clients_json|safe }};
  const dataSales = {{ chart_sales_json|safe }};

  const ctx = document.getElementById('crmChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: '–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏',
          data: dataClients,
          tension: 0.3,
        },
        {
          label: '–°—É–º–∞ –∑–∞–∫—Ä–∏—Ç–∏—Ö —É–≥–æ–¥',
          data: dataSales,
          yAxisID: 'y1',
          tension: 0.3,
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: '–ö–ª—ñ—î–Ω—Ç–∏' } },
        y1: {
          beginAtZero: true,
          position: 'right',
          title: { display: true, text: '–ü—Ä–æ–¥–∞–∂—ñ' },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
</script>
<hr />
<div class="grid">
  <article>
    <header><strong>–ú–æ—ó –∑–∞–¥–∞—á—ñ / —É–≥–æ–¥–∏</strong></header>
    <p>–í–∞—à—ñ –æ—Å—Ç–∞–Ω–Ω—ñ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ —à–≤–∏–¥–∫—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.</p>
    {% comment %} <footer><a href="#" role="button">–ü–µ—Ä–µ–π—Ç–∏</a></footer> {% endcomment %}
    <hr />
    <p>
      <a href="{% url 'activity_create' %}" role="button">+ –î–æ–¥–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</a>
    </p>

  </article>
</div>

<hr />
<form method="get" class="grid" style="align-items:end; gap: 1rem;">
  <div>
    <label for="kind">–¢–∏–ø</label>
    <select name="kind" id="kind">
      <option value="" {% if not filter_kind %}selected{% endif %}>–ë—É–¥—å-—è–∫–∏–π</option>
      <option value="call"  {% if filter_kind == "call" %}selected{% endif %}>–î–∑–≤—ñ–Ω–æ–∫</option>
      <option value="meet"  {% if filter_kind == "meet" %}selected{% endif %}>–ó—É—Å—Ç—Ä—ñ—á</option>
      <option value="deal"  {% if filter_kind == "deal" %}selected{% endif %}>–£–≥–æ–¥–∞</option>
      <option value="task"  {% if filter_kind == "task" %}selected{% endif %}>–ó–∞–≤–¥–∞–Ω–Ω—è</option>
      <option value="other" {% if filter_kind == "other" %}selected{% endif %}>–Ü–Ω—à–µ</option>
    </select>
  </div>

  <div>
    <label for="from">–í—ñ–¥ –¥–∞—Ç–∏</label>
    <input type="date" id="from" name="from" value="{{ filter_from }}">
  </div>

  <div>
    <label for="to">–î–æ –¥–∞—Ç–∏</label>
    <input type="date" id="to" name="to" value="{{ filter_to }}">
  </div>

  <div>
    <label for="sort">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</label>
    <select name="sort" id="sort">
      <option value="-created_at" {% if sort == "-created_at" %}selected{% endif %}>–ù–æ–≤—ñ —Å–ø–æ—á–∞—Ç–∫—É</option>
      <option value="created_at"  {% if sort == "created_at" %}selected{% endif %}>–°—Ç–∞—Ä—ñ —Å–ø–æ—á–∞—Ç–∫—É</option>
      <option value="-duration_min" {% if sort == "-duration_min" %}selected{% endif %}>–î–æ–≤—à—ñ —Å–ø–æ—á–∞—Ç–∫—É</option>
      <option value="duration_min"  {% if sort == "duration_min" %}selected{% endif %}>–ö–æ—Ä–æ—Ç—à—ñ —Å–ø–æ—á–∞—Ç–∫—É</option>
    </select>
  </div>

  <div class="grid">
    <button type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    <button type="button" onclick="window.location.href='{% url 'dashboard' %}'" class="secondary">
      –°–∫–∏–Ω—É—Ç–∏
    </button>
  </div>

</form>

<h3>–ú–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</h3>
<p>–°—å–æ–≥–æ–¥–Ω—ñ: <strong>{{ my_today_count }}</strong></p>

<table>
  <thead>
    <tr>
      <th>–¢–∏–ø</th>
      <th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)</th>
      <th>–ù–æ—Ç–∞—Ç–∫–∏</th>
      <th>–î–∞—Ç–∞</th>
      <th>–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody>
    {% for a in my_latest_activities %}
    <tr>
      <td>{{ a.get_kind_display }}</td>
      <td>{{ a.duration_min }}</td>
      <td>{{ a.notes|default:"‚Äî" }}</td>
      <td>{{ a.created_at|date:"Y-m-d H:i" }}</td>
      <td style="white-space:nowrap">
        <a href="{% url 'activity_edit' a.pk %}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
        &nbsp;|&nbsp;
        <a href="{% url 'activity_delete' a.pk %}">–í–∏–¥–∞–ª–∏—Ç–∏</a>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="4">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endif %} 
{% endblock %}
